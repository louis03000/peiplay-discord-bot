===========================================
ä¿®å¾©ä»£ç¢¼ç‰‡æ®µ - è«‹åœ¨æ‚¨çš„ bot.py ä¸­æ›¿æ›
===========================================

ã€ä¿®å¾© 1ã€‘æ‰¾åˆ° ManualRatingView é¡åˆ¥ï¼Œå°‡æ‰€æœ‰æŒ‰éˆ•çš„ emoji åƒæ•¸ç§»é™¤

æ‰¾åˆ°é€™æ¨£çš„ä»£ç¢¼ï¼š
@discord.ui.button(label="â­ 1æ˜Ÿ", style=discord.ButtonStyle.secondary, emoji="â­")

æ”¹ç‚ºï¼š
@discord.ui.button(label="â­ 1æ˜Ÿ", style=discord.ButtonStyle.secondary)

éœ€è¦ä¿®æ”¹æ‰€æœ‰ 5 å€‹æ˜Ÿç­‰æŒ‰éˆ•ï¼ˆ1-5æ˜Ÿï¼‰ï¼Œä»¥åŠä»»ä½•èº«ä»½é¸æ“‡æŒ‰éˆ•ã€‚

ã€ä¿®å¾© 2ã€‘åœ¨ countdown å‡½æ•¸ä¸­ï¼ˆç´„ç¬¬ 4015 è¡Œï¼‰ï¼Œæ‰¾åˆ°å‰µå»º ManualRatingView çš„åœ°æ–¹

åœ¨å‰µå»º View ä¹‹å‰ï¼Œæ·»åŠ å¾è³‡æ–™åº«ç²å–ç”¨æˆ¶IDçš„ä»£ç¢¼ï¼š

# å¾è³‡æ–™åº«ç²å–æ­£ç¢ºçš„ç”¨æˆ¶ID
with Session() as s:
    record = s.get(PairingRecord, record_id)
    if not record:
        print(f"âŒ æ‰¾ä¸åˆ°é…å°è¨˜éŒ„: {record_id}")
        if text_channel and not text_channel.deleted:
            await text_channel.delete()
        active_voice_channels.pop(vc_id, None)
        return
    
    # ç¢ºä¿å¾è³‡æ–™åº«ç²å–æ­£ç¢ºçš„ç”¨æˆ¶ID
    user1_id = record.user1Id
    user2_id = record.user2Id
    print(f"ğŸ” å¾è³‡æ–™åº«ç²å–ç”¨æˆ¶ID: user1_id={user1_id}, user2_id={user2_id}")

# ç„¶å¾Œå‰µå»º View
view = ManualRatingView(record_id, user1_id, user2_id)

ã€ä¿®å¾© 3ã€‘åœ¨ç™¼é€ç®¡ç†å“¡è¨Šæ¯çš„éƒ¨åˆ†ï¼Œç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ç”¨æˆ¶IDä¸¦æª¢æŸ¥è©•åƒ¹

æ‰¾åˆ°ç™¼é€ç®¡ç†å“¡è¨Šæ¯çš„éƒ¨åˆ†ï¼Œç¢ºä¿ï¼š
1. ä½¿ç”¨å¾è³‡æ–™åº«ç²å–çš„ user1_id å’Œ user2_id
2. æ­£ç¢ºæª¢æŸ¥ pending_ratings å’Œè³‡æ–™åº«ä¸­çš„è©•åƒ¹

===========================================
å®Œæ•´çš„ ManualRatingView ä¿®å¾©ç‰ˆæœ¬
===========================================

class ManualRatingView(discord.ui.View):
    def __init__(self, record_id, user1_id, user2_id):
        super().__init__(timeout=600)  # 10 åˆ†é˜è¶…æ™‚
        self.record_id = record_id
        self.user1_id = user1_id
        self.user2_id = user2_id
        self.ratings = {}
        self.submitted_users = set()
    
    # ä¿®å¾©ï¼šç§»é™¤ emoji åƒæ•¸
    @discord.ui.button(label="â­ 1æ˜Ÿ", style=discord.ButtonStyle.secondary, custom_id="rating_1")
    async def rate_1_star(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.handle_rating(interaction, 1)
    
    @discord.ui.button(label="â­â­ 2æ˜Ÿ", style=discord.ButtonStyle.secondary, custom_id="rating_2")
    async def rate_2_star(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.handle_rating(interaction, 2)
    
    @discord.ui.button(label="â­â­â­ 3æ˜Ÿ", style=discord.ButtonStyle.secondary, custom_id="rating_3")
    async def rate_3_star(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.handle_rating(interaction, 3)
    
    @discord.ui.button(label="â­â­â­â­ 4æ˜Ÿ", style=discord.ButtonStyle.secondary, custom_id="rating_4")
    async def rate_4_star(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.handle_rating(interaction, 4)
    
    @discord.ui.button(label="â­â­â­â­â­ 5æ˜Ÿ", style=discord.ButtonStyle.secondary, custom_id="rating_5")
    async def rate_5_star(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.handle_rating(interaction, 5)
    
    # å¦‚æœæœ‰èº«ä»½é¸æ“‡æŒ‰éˆ•ï¼Œä¹Ÿç§»é™¤ emoji åƒæ•¸
    @discord.ui.button(label="ğŸ‘¤ æˆ‘æ˜¯é¡§å®¢", style=discord.ButtonStyle.primary, custom_id="role_customer")
    async def select_customer(self, interaction: discord.Interaction, button: discord.ui.Button):
        self.selected_role = "customer"
        await interaction.response.send_message("âœ… æ‚¨å·²é¸æ“‡ã€Œé¡§å®¢ã€èº«ä»½", ephemeral=True)
    
    @discord.ui.button(label="ğŸ‘¤ æˆ‘æ˜¯å¤¥ä¼´", style=discord.ButtonStyle.primary, custom_id="role_partner")
    async def select_partner(self, interaction: discord.Interaction, button: discord.ui.Button):
        self.selected_role = "partner"
        await interaction.response.send_message("âœ… æ‚¨å·²é¸æ“‡ã€Œå¤¥ä¼´ã€èº«ä»½", ephemeral=True)
    
    async def handle_rating(self, interaction: discord.Interaction, rating: int):
        user_id = interaction.user.id
        
        # æª¢æŸ¥æ˜¯å¦å·²ç¶“è©•åƒ¹é
        if user_id in self.submitted_users:
            await interaction.response.send_message("â— æ‚¨å·²ç¶“æäº¤éè©•åƒ¹äº†ã€‚", ephemeral=True)
            return
        
        # æ‰“é–‹è©•åƒ¹è¡¨å–®
        modal = RatingModal(self.record_id, rating)
        await interaction.response.send_modal(modal)

